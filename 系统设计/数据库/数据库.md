# 数据库

<img width="2184" height="1276" alt="image" src="https://github.com/user-attachments/assets/57bcbdfb-7e15-4539-a6bb-48ed58953149" />

## 关系型数据库管理系统（RDBMS）

像 MYSQL 这样的关系型数据库是一系列以表的形式组织的数据项集合

ACID 用来描述关系型数据库事务的特性

* 原子性 - 每个事务内部所有操作要么全部完成，要么全部不完成
  
* 一致性 - 任何事务都使数据库从一个有效的状态转换到另一个有效状态
  
* 隔离性 - 并发执行事务的结果与顺序执行事务的结果相同
  
* 持久性 - 事务提交后，对系统的影响是永久的

关系型数据库扩展包括许多技术：主从复制、主主复制、联合、分片、非规范化和 SQL调优

<img width="1246" height="839" alt="image" src="https://github.com/user-attachments/assets/7cb86e0e-53d9-4c9c-8a7a-22556615cc80" />

### 主从复制

主库同时负责读取和写入操作，并复制写入到一个或多个从库中，从库只负责读操作。树状形式的从库再将写入复制到更多的从库中去。如果主库离线，系统可以以只读模式运行，直到某个从库被提升为主库或有新的主库出现

### 缺陷：主从复制

* 将从库提升为主库需要额外的逻辑

* 参考缺陷：复制中，主从复制和主主复制共同的问题

<img width="1028" height="610" alt="image" src="https://github.com/user-attachments/assets/dfcb89b8-07af-40d4-a7d0-c4588769bba4" />

### 主主复制

两个主库都负责读操作和写操作，写入操作时互相协调。如果其中一个主库挂机，系统可以继续读取和写入

### 缺陷：主主复制

* 你需要添加负载均衡器或者在应用逻辑中做改动，来确定写入哪一个数据库

* 多数主-主系统要么不能保证一致性（违反 ACID），要么因为同步产生了写入延迟
  
* 随着更多写入节点的加入和延迟的提高，如何解决冲突显得越发重要
  
* 参考不利之处：复制中，主从复制和主主复制共同的问题

### 联合

<img width="594" height="768" alt="image" src="https://github.com/user-attachments/assets/4e3ba680-c4af-4e1d-b118-d151b65bd106" />

联合（或按功能划分）将数据库按对应功能分割。例如，你可以有三个数据库：论坛、用户和产品，而不仅是一个单体数据库，从而减少每个数据库的读取和写入流量，减少复制延迟。较小的数据库意味着更多适合放入内存的数据，进而意味着更高的缓存命中几率。没有只能串行写入的中心化主库，你可以并行写入，提高负载能力

### 缺陷：联合

* 如果你的数据库模式需要大量的功能和数据表，联合的效率并不好

* 你需要更新应用程序的逻辑来确定要读取和写入哪个数据库

* 用 server link 从两个库联结数据更复杂

* 联合需要更多的硬件和额外的复杂度

### 分片

<img width="642" height="728" alt="image" src="https://github.com/user-attachments/assets/3d180934-941b-4693-aebf-de6b93a1cc5f" />

分片将数据分配在不同的数据库上，使得每个数据库仅管理整个数据集的一个子集。以用户数据库为例，随着用户数量的增加，越来越多的分片会被添加到集群中

类似联合的优点，分片可以减少读取和写入流量，减少复制并提高缓存命中率。也减少了索引，通常意味着查询更快，性能更好。如果一个分片出问题，其他的仍能运行，你可以使用某种形式的冗余来防止数据丢失。类似联合，没有只能串行写入的中心化主库，你可以并行写入，提高负载能力

常见的做法是用户姓氏的首字母或者用户的地理位置来分隔用户表

### 缺陷：分片

* 你需要修改应用程序的逻辑来实现分片，这会带来复杂的 SQL 查询
  
* 分片不合理可能导致数据负载不均衡。例如，被频繁访问的用户数据会导致其所在分片的负载相对其他分片高。再平衡会引入额外的复杂度。基于一致性哈希的分片算法可以减少这种情况
  
* 联结多个分片的数据操作更复杂

* 分片需要更多的硬件和额外的复杂度

### SQL 调优

利用基准测试和性能分析来模拟和发现系统瓶颈很重要

* 基准测试 - 用 ab 等工具模拟高负载情况

* 性能分析 - 通过启用如慢查询日志等工具来辅助追踪性能问题

基准测试和性能分析可能会指引你到以下优化方案

#### 改进模式

* 为了实现快速访问，MySQL 在磁盘上用连续的块存储数据。

* 使用 CHAR 类型存储固定长度的字段，不要用 VARCHAR。CHAR 在快速、随机访问时效率很高。如果使用 VARCHAR，如果你想读取下一个字符串，不得不先读取到当前字符串的末尾

* 使用 TEXT 类型存储大块的文本，例如博客正文。TEXT 还允许布尔搜索。使用 TEXT 字段需要在磁盘上存储一个用于定位文本块的指针

* 使用 INT 类型存储高达 2^32 或 40 亿的较大数字

* 使用 DECIMAL 类型存储货币可以避免浮点数表示错误

* 避免使用 BLOBS 存储实际对象，而是用来存储存放对象的位置

* VARCHAR(255) 是以 8 位数字存储的最大字符数，在某些关系型数据库中，最大限度地利用字节

* 在适用场景中设置 NOT NULL 约束来提高搜索性能。

#### 使用正确的索引

* 你正查询（SELECT、GROUP BY、ORDER BY、JOIN）的列如果用了索引会更快

* 索引通常表示为自平衡的 B 树，可以保持数据有序，并允许在对数时间内进行搜索，顺序访问，插入，删除操作

* 设置索引，会将数据存在内存中，占用了更多内存空间

* 写入操作会变慢，因为索引需要被更新

* 加载大量数据时，禁用索引再加载数据，然后重建索引，这样也许会更快

#### 避免高成本的联结操作

* 有性能需要，可以进行非规范化

#### 分割数据表

* 将热点数据拆分到单独的数据表中，可以有助于缓存

#### 调优查询缓存

* 在某些情况下，查询缓存可能会导致性能问题

## NoSQL

NoSQL 是键-值数据库、文档型数据库、列型数据库或图数据库的统称。数据库是非规范化的，表联结大多在应用程序代码中完成。大多数 NoSQL 无法实现真正符合 ACID 的事务，支持最终一致

BASE 通常被用于描述 NoSQL 数据库的特性。相比 CAP 理论，BASE 强调可用性超过一致性

* 基本可用 - 系统保证可用性。

* 软状态 - 即使没有输入，系统状态也可能随着时间变化。

* 最终一致性 - 经过一段时间之后，系统最终会变一致，因为系统在此期间没有收到任何输入

### 键-值存储

键-值存储通常可以实现 O(1) 时间读写，用内存或 SSD 存储数据。数据存储可以按字典顺序维护键，从而实现键的高效检索。键-值存储可以用于存储元数据

键-值存储性能很高，通常用于存储简单数据模型或频繁修改的数据，如存放在内存中的缓存。键-值存储提供的操作有限，如果需要更多操作，复杂度将转嫁到应用程序层面

键-值存储是如文档存储，在某些情况下，甚至是图存储等更复杂的存储系统的基础

### 文档类型存储

文档类型存储以文档（XML、JSON、二进制文件等）为中心，文档存储了指定对象的全部信息。文档存储根据文档自身的内部结构提供 API 或查询语句来实现查询。请注意，许多键-值存储数据库有用值存储元数据的特性，这也模糊了这两种存储类型的界限

基于底层实现，文档可以根据集合、标签、元数据或者文件夹组织。尽管不同文档可以被组织在一起或者分成一组，但相互之间可能具有完全不同的字段

MongoDB 和 CouchDB 等一些文档类型存储还提供了类似 SQL 语言的查询语句来实现复杂查询。DynamoDB 同时支持键-值存储和文档类型存储

文档类型存储具备高度的灵活性，常用于处理偶尔变化的数据

### 列型存储

<img width="581" height="231" alt="image" src="https://github.com/user-attachments/assets/2155b19b-9968-4e77-a7bf-984fc59f99d3" />


类型存储的基本数据单元是列（名／值对）。列可以在列族（类似于 SQL 的数据表）中被分组。超级列族再分组普通列族。你可以使用行键独立访问每一列，具有相同行键值的列组成一行。每个值都包含版本的时间戳用于解决版本冲突

Google 发布了第一个列型存储数据库 Bigtable，它影响了 Hadoop 生态系统中活跃的开源数据库 HBase 和 Facebook 的 Cassandra。像 BigTable，HBase 和 Cassandra 这样的存储系统将键以字母顺序存储，可以高效地读取键列

列型存储具备高可用性和高可扩展性。通常被用于大数据相关存储

### 图数据库

<img width="616" height="436" alt="image" src="https://github.com/user-attachments/assets/560f5f63-eb8b-4aab-b55b-533fcfd99cdc" />

在图数据库中，一个节点对应一条记录，一个弧对应两个节点之间的关系。图数据库被优化用于表示外键繁多的复杂关系或多对多关系

图数据库为存储复杂关系的数据模型，如社交网络，提供了很高的性能。它们相对较新，尚未广泛应用，查找开发工具或者资源相对较难。许多图只能通过 REST API 访问

## SQL 还是 NoSQL

<img width="553" height="316" alt="image" src="https://github.com/user-attachments/assets/6d3b7d12-3b3f-4c0a-b453-1d91cd391b65" />

选取 SQL 的原因:

* 结构化数据

* 严格的模式

* 关系型数据

* 需要复杂的联结操作

* 事务

* 清晰的扩展模式

* 既有资源更丰富：开发者、社区、代码库、工具等

* 通过索引进行查询非常快

选取 NoSQL 的原因：

* 半结构化数据

* 动态或灵活的模式

* 非关系型数据

* 不需要复杂的联结操作

* 存储 TB （甚至 PB）级别的数据

* 高数据密集的工作负载

* IOPS 高吞吐量

适合 NoSQL 的示例数据：

* 埋点数据和日志数据

* 排行榜或者得分数据

* 临时数据，如购物车

* 频繁访问的（“热”）表

* 元数据／查找表

